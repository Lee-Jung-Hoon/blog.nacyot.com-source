도쿠 2번째 이야기. 얼마 전에 도커를 소개하고, 도커를 기반으로 기반으로 한 도쿠를 통해 미니 히로쿠를 구축하는 방법을 소개한 바 있습니다. 미니 히로쿠를 구축하는 글에서는 nodejs 샘플 앱을 배포하고, 도쿠의 원리에 대해서 가볍게 살펴보았습니다. 이번 글에서는 도쿠를 통해 좀 더 현실적인 예제로 레일즈4 어플리케이션을 실제로 배포하는 방법을 소개하고자 합니다. 원론적으로는 정말 쉽게 되어야합니다만 이해해야하거나 해결해야할 약간의 문제점이 있습니다.

<!--more-->

## 도쿠(Dokku)를 통한 어플리케이션 배포 ##

앞선 글을 읽었다는 전제 하에 이야기를 계속해나가도록 하겠습니다. 편의를 위해 먼저 조금 정리를 해보죠.

nodejs-sample 어플리케이션을 배포하는 예제를 통해서 도쿠가 어떻게 어플리케이션을 배포하는 지 큰 그림을 그려보셨을 거라고 생각합니다. 여기서, 도커와 어플리케이션 사이에서 도쿠는 어플리케이션의 저장소 역할과 함께 어플리케이션을 빌드해주는 역할을 합니다. 기본적으로 도쿠는 Git 원격 저장소로 이루어져있습니다. 도커가 Git과 비슷한 개념으로 이미지를 사용한다면 도쿠는 그냥 실제로 Git을 이용합니다. 어플리케이션을 만들면 Docker 서버 측에 Git 원격 저장소를 생성해서 어플리케이션을 관라히며, 이 저장소(저장소가 없으면 새로 생성됩니다)에 적절한 권한이 있는 사용자가 특정한 언어나 프레임워크로 이루어진 푸쉬를 보내면 Git의 Hook 기능을 통해서 서버에서 적절한 스크립트를 실행합니다.

이 스크립트가 하는 일은 여러가지가 있습니다. 그 중에서도 가장 중요한 부분은 `progrium/buildstep` 이미지로부터 어플리케이션이 포함된 이미지를 생성하는 일입니다. 이 과정에서 미리 `buildstep` 컨테이너를 실행시키고, 이 컨테이너에 미리 포함시켜둔 heroku-buildpack을 이용해 어플리케이션을 적절히 빌드합니다. 빌드된 어플리케이션은 자동으로 컨테이너로 실행되며, 실행된 컨테이너를 nginx 프록시를 통해 미리 지정해둔 도메인의 서브도메인으로 연결시켜줍니다. 네, 이게 도쿠의 큰 줄거리입니다.

별 거 없죠?

이러쿵 저러쿵 했지만 결론은 간단합니다. Dokku 설치 후 기본적인 세팅을 한 후 만들고 있는 어플리케이션 저장소에서 아래 명령을 실행시켜주기만 하면됩니다. 

```
$ git remote add dokku dokku@<도쿠_서버_주소>:<앱_이름>
$ git push dokku master
```

이 명령어는 저장소가 없는 경우에 dokku git 서버에 새로운 저장소를 추가까지 해줍니다. 또한 앱 이름은 도메인의 서브 도메인이 되는데, 이 때 다른 도메인을 연결하고자한다면, 앱 이름은 도메인 풀 네임을 지정하는 것도 가능합니다(예를 들자면 `:wiki.nacyot.com`). 이렇게 지정하면 해당하는 도메인을 nginx가 바로 연결시켜줍니다. 물론 실제로 도메인에 연결 가능 여부는 (너무 당연한 이야기지만) dns 설정이 dokku 서버 쪽으로 정상적으로 되어있을 경우에 한합니다.

## 도쿠를 통한 레일즈 어플리케이션 배포 ##

네, 이 글에서 다룰 본격적인 주제는 도쿠를 통한 레일즈 어플리케이션 배포입니다. 이 글의 주제로 넘어가보죠. 그렇다면 루비나 레일즈 어플리케이션을 배포하고자 할 때는 다른 점이 있을까요?

네, 정답입니다.

없습니다.

```
$ git remote add dokku dokku@<도쿠_서버_주소>:<앱_이름>
$ git push dokku master
```

우와 쉽네요. 이 글은 이걸로 끝입니다...

끝입니다. 네?

정말 끝인가요??

```
오류 메시지
```

안타깝게도 만사가 그렇게 쉽게는 진행되지는 않는 법입니다.

### 도쿠와 히로쿠 ###

하지만 너무 안타까워하실 필요는 없습니다. 좋은 소식(?)을 알려드린다면,  히로쿠 써보신 분들은 아시겠지만 히로쿠라고 해서 그렇게 배포가 쉽지만은 않습니다. 예를 들면 히로쿠는 기본적으로 postgresql를 지원합니다. 치명적인 단점으로 레일즈에서 기본으로 들어가있는 sqlite3를 전혀 지원하지 않습니다. 권장하지 않는 게 아니라, 아예 실행이 안 됩니다. 그 외에도 `rails_12factor` Gem의 존재라거나 에셋 파이프라인에서 오는 에러메시지의 합주곡은 결코 만만하지 않습니다. 이런 시행 착오를 겪어보고 아 이제 히로쿠 좀 써봐야겠다 싶으면 가격이 결코 만만하지 않습니다 :)

다시 도쿠 이야기입니다만, 도쿠에서 사용하는 Heroku-Buildpack을 사용할 때는 기본적으로 Heroku에서 겪을 수 있는 문제들을 전부 고스란히 겪을 수 있습니다. 예를 들어 단순히 sqlite3를 쓸 수 없다는 게 중요한 게 아니라 내부적으로 빌드 과정에서 database.yml을 덮어씌워버린다는 사실을 알고 있어야합니다. 다른 문제들도 마찬가지입니다. `rails_12factor` Gem의 존재도 그렇고, 파이프라인을 어떻게 처리해야하는지도 이해할 필요가 있습니다. 이런 문제들은 겪어보지 않으면 이해하기도 어렵습니다. 공개된 빌드팩이 히로쿠에서 서비스하는 것과 완전히 같은지는 모르겠습니다만, 히로쿠에서 겪은 시행착오는 도쿠를 사용하는데도 많은 도움이 됩니다. 아직 히로쿠를 사용해본 적이 없지만 도쿠를 써보고 싶은 분이라면, 도쿠보다도 히로쿠부터 시작하는 걸 추천해드립니다. (레일즈 튜토리얼은 이런 접근에 있어서 특히 좋은 교재입니다.)

도쿠에서 실제 어플리케이션을 배포하는 데 핵심적인 키는 다름 아닌 히로쿠 빌드팩입니다.

(도쿠와 히로쿠를 비교하는 것이 정당한 비교가 아니긴 합니다. 히로쿠는 훨씬 다양한 기능을 서비스로 지원하고 있으며, 많은 종류의 서드파티 확장을 지원하고 있습니다. 일차원적으로 히로쿠 빌드팩을 쓴다고 도쿠가 히로쿠가 되는 것은 아닙니다.)

### 루비 온 레일즈 온 도쿠 ###

그럼 실제로 문제를 하나하나 잡아가보도록 하겠습니다



제가 여기에서 소개하는 내용은 nodejs-sample을 배포하듯이 `git push dokku master` 명령어만으로(혹은 단지 몇 개 명령어를 더 붙이는 정도로) 레일즈 어플리케이션을 배포하고 업데이트하는 것이 가능하도록 하기 위해서 거쳐야할 과정들입니다. 해결해야할 이슈들은 아래와 같습니다.

1. `rails_12factor` 젬 설치
1. `pg` 젬 설치 및 도쿠 확장을 통한 postgresql 세팅
1. (외부 데이터베이스나 sqlite3 사용하는 법)
1. Heroku-Buidpack-Ruby의 루비 다운로드 과정에서 타임아웃 문제 해결.
1. 기본 `progrium/buildstep`에서 시스템에 설치되는 루비 버전 문제
1. db:migrate

그래도 알고 있으면 쉽게 해결할 수 있는 문제들입니다. 몇 개 안 되니 하나하나 해결해나가도록 하죠.

###  ###
